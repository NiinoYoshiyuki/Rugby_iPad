<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Sync StopWatch - Premium</title>
<style>
body {
    font-family: 'Helvetica Neue', Arial, sans-serif;
    background-color: #121212;
    color: #e0e0e0;
    text-align: center;
    margin: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    height: 100vh;
}

/* メインタイマー */
#time {
    font-size: 120px;
    font-weight: 200;
    font-variant-numeric: tabular-nums;
    letter-spacing: -2px;
    margin-bottom: 30px;
    color: #ffffff;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
}

/* ボタンの共通スタイル */
button {
    font-size: 18px;
    font-weight: 600;
    padding: 12px 30px;
    margin: 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    outline: none;
}

button:active {
    transform: translateY(2px);
}

/* メイン操作系 */
#toggleBtn {
    font-size: 24px;
    padding: 18px 50px;
    min-width: 180px;
}
.running { background-color: #ff4d4d; color: white; box-shadow: 0 4px 15px rgba(255, 77, 77, 0.3); }
.paused { background-color: #00c851; color: white; box-shadow: 0 4px 15px rgba(0, 200, 81, 0.3); }
.reset-btn { background-color: #424242; color: #bdbdbd; }

/* 修正エリア（エディタ） */
#editor {
    margin-top: 50px;
    padding: 25px;
    background-color: #1e1e1e;
    display: inline-block;
    border-radius: 16px;
    border: 1px solid #333;
}
#editor span { font-size: 20px; color: #9e9e9e; margin: 0 10px; vertical-align: middle; }

input[type="number"] {
    font-size: 32px;
    width: 100px;
    height: 60px;
    background-color: #333;
    border: 2px solid #444;
    color: white;
    border-radius: 10px;
    text-align: center;
    vertical-align: middle;
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
    opacity: 1;
    height: 50px;
    width: 30px;
}
.apply-btn { background-color: #007bff; color: white; vertical-align: middle; }

/* トライ専用エリア */
.tri-section {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px dashed #333;
}

/* 90秒専用タイマーの表示 */
#triDisplay {
    font-size: 36px;
    color: #ffab00;
    font-weight: bold;
    margin-bottom: 10px;
    height: 45px;
}

.tri-btn {
    background-color: #ffab00;
    color: #000;
    font-size: 28px;
    padding: 20px 60px;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(255, 171, 0, 0.3);
}
.tri-btn:hover {
    background-color: #ffc400;
}
</style>
</head>
<body>

<div id="time">00:00</div>

<div class="controls">
    <button id="toggleBtn" class="paused" onclick="toggle()">START</button>
    <button class="reset-btn" onclick="reset()">RESET</button>
</div>

<div id="editor">
    <input type="number" id="minInput" min="0" value="0"> <span>分</span>
    <input type="number" id="secInput" min="0" max="59" value="0"> <span>秒</span>
    <button class="apply-btn" onclick="applyTime()">時間設定</button>

    <div class="tri-section">
        <div id="triDisplay">--</div>
        <button class="tri-btn" onclick="start90sTri()">90s TRY (START)</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK3Zumcpp6Q9KdU8xIzn7dzupiQwOPIE0",
  authDomain: "realtime-database-ae171.firebaseapp.com",
  databaseURL: "https://realtime-database-ae171-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "realtime-database-ae171",
  storageBucket: "realtime-database-ae171.firebasestorage.app",
  messagingSenderId: "119470956682",
  appId: "1:119470956682:web:3ee2d71ff10679d91acd73"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const stateRef = ref(db, "stopwatch");
const triRef = ref(db, "triTimer");

let localState = { running: false, startTime: 0, elapsed: 0 };
let triState = { running: false, startTime: 0, elapsed: 0 };

onValue(stateRef, (snapshot) => {
    if(snapshot.exists()) {
        localState = snapshot.val();
        updateButton();
    }
});

onValue(triRef, (snapshot) => {
    if(snapshot.exists()) {
        triState = snapshot.val();
    }
});

function getTotal() {
    let total = localState.elapsed;
    if(localState.running) total += Date.now() - localState.startTime;
    return total;
}

function getTriTotal() {
    if (!triState.running) return triState.elapsed;
    let remain = triState.elapsed - (Date.now() - triState.startTime);
    return remain > 0 ? remain : 0;
}

function updateDisplay() {
    // メインタイマー
    let total = getTotal();
    let sec = Math.floor(total/1000)%60;
    let min = Math.floor(total/60000);
    document.getElementById("time").innerText = String(min).padStart(2,"0")+":"+String(sec).padStart(2,"0");

    // 90秒タイマー
    let triTotal = getTriTotal();
    if (triState.running || (triTotal > 0 && triTotal < 90000)) {
        let totalSeconds = Math.ceil(triTotal / 1000);
        document.getElementById("triDisplay").innerText = "LIMIT: " + totalSeconds + "s";
        
        // 0秒になったら停止状態をFirebaseに保存
        if (triState.running && triTotal <= 0) {
            set(triRef, { running: false, startTime: 0, elapsed: 0 });
        }
    } else if (triTotal === 90000 && !triState.running) {
        document.getElementById("triDisplay").innerText = "90s";
    } else {
        document.getElementById("triDisplay").innerText = "--";
    }
}
setInterval(updateDisplay, 100);

function updateButton() {
    const btn = document.getElementById("toggleBtn");
    if(localState.running) {
        btn.innerText = "PAUSE";
        btn.className = "running";
    } else {
        btn.innerText = "START";
        btn.className = "paused";
    }
}

window.toggle = function() {
    if(localState.running) {
        set(stateRef, { running: false, startTime: 0, elapsed: getTotal() });
    } else {
        set(stateRef, { running: true, startTime: Date.now(), elapsed: localState.elapsed });
    }
}

window.reset = function() {
    set(stateRef, { running: false, startTime: 0, elapsed: 0 });
    set(triRef, { running: false, startTime: 0, elapsed: 0 });
}

window.applyTime = function() {
    let min = parseInt(document.getElementById("minInput").value) || 0;
    let sec = parseInt(document.getElementById("secInput").value) || 0;
    set(stateRef, { running: false, startTime: 0, elapsed: (min*60 + sec)*1000 });
}

window.start90sTri = function() {
    // ボタンが押されたときだけ開始
    set(triRef, {
        running: true,
        startTime: Date.now(),
        elapsed: 90 * 1000
    });
}
</script>

</body>
</html>
